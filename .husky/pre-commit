#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check for potentially sensitive files
STAGED_FILES=$(git diff --cached --name-only)
SENSITIVE_PATTERNS='.env|.key|password|token|secret|credential|.pem'

echo "üîç Checking for sensitive files..."

for file in $STAGED_FILES; do
  if echo "$file" | grep -E "$SENSITIVE_PATTERNS" > /dev/null; then
    echo "‚ö†Ô∏è  Warning: Potential sensitive file detected: $file"
    echo "   Please make sure this file doesn't contain real credentials."
    
    # If the file contains actual secrets, block the commit
    if grep -E "(API_KEY|SECRET|PASSWORD|TOKEN).*='[A-Za-z0-9_\-]{8,}'" "$file" > /dev/null; then
      echo "‚ùå Error: Blocking commit due to potential secret in: $file"
      echo "   Remove the secrets or add the file to .gitignore"
      exit 1
    fi
  fi
done

# Run tests before commit
echo "Running tests before commit..."
npm test

# If tests fail, prevent the commit
if [ $? -ne 0 ]; then
  echo "Tests failed. Please fix the failing tests before committing."
  exit 1
fi

# Continue with the commit if tests pass
exit 0

# Run lint-staged for other checks
npx lint-staged 